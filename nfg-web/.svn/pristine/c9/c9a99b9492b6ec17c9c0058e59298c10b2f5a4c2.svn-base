function Reclamacao(options){
    var me = this;
    me.build(options);
    me.urlBase = options.urlBase;
    me.numeroCnpj = options.numeroCnpj;
    $(".textCnpj").html(toCnpjFormat($(".textCnpj").html()));
    $(".textCpf").html(toCpfFormat($(".textCpf").html()));
    $(".textMoney").html(toMoneyFormat($(".textMoney").html()));
    me.incluirComplemento(options.numeroCnpj, options.urlBase);
    me.modalReclamacaoDetalhe();
    me.mudancaAcaoReclamacao();
    me.alterarReclamacao();
}

Reclamacao.prototype.build = function(options){
    var me = this;
    if(options != null && options.tela == "reclamacaoIndex"){
        me.gridReclamacaoUsuario();
    }

    if(options != null && options.tela == "consultar"){
        me.eventoListar(options.urlBase, options.numeroCnpj);
    }
}

Reclamacao.prototype.gridReclamacaoUsuario = function(){
    var me = this;
    me.pagination = new NFGPagination({
        url: enderecoSite + "/portal/reclamacao/usuario/listarReclamacoes",
        containerSelector: "#containerReclamacoesUsuario",
        templateSelector: "#tabelaReclamacoesUsuario",
        formFilterSelector: "#formReclamacoesUsuario",

        beforeLoad: function() {
            bloqueioDeTela("#dadosReclamacoesCadastradas");
        },
        afterLoad: function() {
            $("#dadosReclamacoesCadastradas").unblock();
        }
    });
    me.pagination.init(0);
}

Reclamacao.prototype.eventoListar = function(url, cnpj){
    nfgMensagens.remove();
    var me = this;
    me.pagination = new NFGPagination({
        url: enderecoSite + url + "listar",
        containerSelector: "#containerReclamacao",
        templateSelector:  "#tabelaReclamacaoEmpresaContador"
    });

    var hash = window.location.hash.replace("#","");
    var page = parseInt(hash) ? parseInt(hash) : 1;
    me.pagination.afterLoad= me.mostrarComplemento.bind(me);
    me.pagination.init(page, {numeroCnpj : cnpj, urlBase: url});
}

Reclamacao.prototype.mostrarComplemento = function(data){
    $("#messagesContainer").html("");
    $("#inputIdReclamacao").val("");
    $("#descricaoComplemento").val("");
    $("#selectAcoesDisponiveisEmpresa").val("");
    $(".optradio-reclamacao").off("click");
    $(".optradio-reclamacao").on("click", function(e) {

        var idReclamacao = $(this).val();
        $.ajax({
            url: enderecoSite + data.urlBase + "/selectStatus",
            data:{
                idReclamacao: idReclamacao
            },
            type: 'POST',
            success: function(response) {
                if(response.statusDisponiveis.length > 0){
                    $("#containerComplemento").css('display', 'block');
                    $("#containerComplemento").find("#inputIdReclamacao").val(idReclamacao);
                    var select = $("#selectAcoesDisponiveisEmpresa");
                    select.find('option')
                        .remove()
                        .end()
                        .append('<option value="-1" >Selecione</option>');
                    $.each(response.statusDisponiveis, function() {
                        select.append($("<option />").val(this.codigo).text(this.tipoSituacaoAcao));
                    });
                }else{
                    $("#containerComplemento").css('display', 'none');
                }
            }
        });
    });
}

Reclamacao.prototype.incluirComplemento = function(cnpj, urlBase){
    $("#btnComplemento").on("click", function(e){

        var descricaoComplemento = $("#descricaoComplemento").val().trim();
        var codigoAcao = $("#selectAcoesDisponiveisEmpresa").val();
        var idReclamacao = $("#inputIdReclamacao").val();

        if(idReclamacao == ""){
            nfgMensagens.show(ALERT_TYPES.ERROR,'Selecione a Reclamação',false);
            return;
        }

        if(codigoAcao == -1){
            nfgMensagens.show(ALERT_TYPES.ERROR,'Selecione o Status',false);
            $("#selectAcoesDisponiveisEmpresa").focus();
            return;
        }

        $.ajax({
            url: enderecoSite + urlBase + "/incluirComplemento",
            data: {
                descricaoComplemento : descricaoComplemento,
                codigoAcao : codigoAcao,
                idReclamacao : idReclamacao,
                cnpj: cnpj
            },
            type: 'POST',
            success: function(response) {
                if(response.sucesso){
                    nfgMensagens.show(ALERT_TYPES.SUCCESS,'Reclamação atualizada com sucesso. Continue acompanhando-a na listagem de andamento da reclamação.',false);
                    $("#containerComplemento").css('display', 'none');
                }else{
                    nfgMensagens.show(ALERT_TYPES.ERROR,'Erro ao tentar atualizar a situação da reclamaçãoo. Tente de novo posteriormente.',false);
                }
            }
        });
    });
}

Reclamacao.prototype.modalReclamacaoDetalhe = function(){
    var me = this;
    $(".abrirReclamacaoLink").off("click");
    $("body").on("click", ".abrirReclamacaoLink", function(e) {
        var idReclamacaoLink = $(this).parent().find('.idReclamacaoLink').html().trim();

        if(idReclamacaoLink==null || idReclamacaoLink.length==0){
            nfgMensagens.show(ALERT_TYPES.ERROR,"Erro na visualiza��o da reclama��o. Tente de novo posteriormente.");
            return;
        }

        bloqueioDeTela("#divPaineisTelaInicial");
        $("#modalHomeBody").load('verReclamacaoDetalhe/'+idReclamacaoLink,
            function( response, status, xhr ) {
                if ( status == "error" ) {
                    window.location.replace(enderecoSite+"/cidadao/login");
                } else {
                    $("#modalHomeTitle").html('Reclama��o em detalhe');
                    $(".modal-dialog").attr("class","modal-dialog modal-lg"); //modal largo

                    $("#modalhome").modal('show');
                    me.carregaGridAndamentoReclamacao();
                    me.resetaElementosAcaoReclamacao();
                    $("#divPaineisTelaInicial").unblock();
                }
            }
        );
    });
}

Reclamacao.prototype.carregaGridAndamentoReclamacao = function(){
    var me = this;
    me.pagination = new NFGPagination({
        url: enderecoSite + "/portal/reclamacao/usuario/listarAndamentoReclamacao",
        containerSelector: "#containerAndamentoReclamacao",
        templateSelector: "#tabelaAndamentoReclamacao",
        formFilterSelector: "#formAndamentoReclamacao",
        btnFilterSelector: "#btnAndamentoReclamacao",
        beforeLoad: function(data) {
            if(data){
                data.idReclamacao = $("#idReclamacao").val();
            }
        }
    });
    var hash = window.location.hash.replace("#","");
    var page = parseInt(hash) ? parseInt(hash) : 1;
    me.pagination.init(page);
}

Reclamacao.prototype.resetaElementosAcaoReclamacao = function(){
    var me= this;

    $("#divInfoReclamacao").css('display','none');
    $("#btnAlterarReclamacao").css('display','none');
    $("#selectNovoStatusReclamacao").val("-1");

    var codgSituacao = $("#codgSituacaoReclamacao").val();
    if(codgSituacao==15){
        $("#painelAcoesUsuarioReclamacao").css('display','none');
    }else{
        $("#painelAcoesUsuarioReclamacao").css('display','block');
    }
}

Reclamacao.prototype.mudancaAcaoReclamacao = function(){
    var me= this;
    $("body").on("change", "#selectNovoStatusReclamacao", function() {
        if($(this).val()=="-1"){
            $("#btnAlterarReclamacao").css('display','none');
        }else{
            $("#btnAlterarReclamacao").css('display','inline');
        }

        switch ($(this).val()){
            case "-1": /**Aguardar*/
            $("#divInfoReclamacao").css('display','none');
                return;
            case "11": /**Cancelar*/
            $("#divInfoReclamacao").css('display','none');
                return;
            case "12":  /**Acionar fiscaliza��o e notificar empresa*/
            $("#divInfoReclamacao").css('display','block');
                return;
            case "13": /**Notificar cidad�o que reclama��o n�o procede*/
            $("#divInfoReclamacao").css('display','block');
                return;
        }
    });
}

Reclamacao.prototype.alterarReclamacao = function(){
    var me= this;
    $("#btnAlterarReclamacao").off("click");
    $("#painelAcoesUsuarioReclamacao").on("click", "#btnAlterarReclamacao", function() {
        var codgTipoCompl = $("#selectNovoStatusReclamacao option:selected").val();
        var comentario= $("#infoReclamacao").val();
        var idReclamacao = $("#idReclamacao").val();

        ajaxBloqueioDeTela(this,
            enderecoSite+'/portal/reclamacao/usuario/alterarSituacaoReclamacao',
            {idReclamacao:idReclamacao,novoCodgTipoCompl:codgTipoCompl,infoReclamacao:comentario},
            'POST',
            function(response){

                if(response.sucesso){
                    nfgMensagens.show(ALERT_TYPES.SUCCESS,"Atualiza��o realizada com sucesso. Continue acompanhando-a na listagem de andamento da reclama��o.",true);
                }else{
                    nfgMensagens.show(ALERT_TYPES.ERROR,"Erro ao tentar atualizar a situa��o da reclama��o. Tente de novo posteriormente.",true);
                }

                $("#btnAndamentoReclamacao").click();
                $("#btnReclamacoes").click();
                me.carregaComboAcoesDisponiveisReclamacao();
                me.resetaElementosAcaoReclamacao();
            }
        )
    });
}

Reclamacao.prototype.carregaComboAcoesDisponiveisReclamacao = function(){
    var me= this;
    var idReclamacao = $("#idReclamacao").val();
    $.ajax({
        url: enderecoSite + "/portal/reclamacao/usuario/selectAcoesDisponiveis",
        data:{
            idReclamacao: idReclamacao
        },
        type: 'POST',
        success: function(response) {
            var select = $("#selectNovoStatusReclamacao");
            select.find('option')
                .remove()
                .end()
                .append('<option value="-1" >Aguardar</option>');
            $.each(response.acoesDisponiveis, function() {
                select.append($("<option />").val(this.codigo).text(this.tipoSituacaoAcao));
            });
        }
    });
}

